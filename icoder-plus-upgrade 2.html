  // Deep clone object
  deepClone: (obj) => {
    if (obj === null || typeof obj !== 'object') return obj;
    if (obj instanceof Date) return new Date(obj.getTime());
    if (obj instanceof Array) return obj.map(item => utils.deepClone(item));
    if (typeof obj === 'object') {
      const cloned = {};
      Object.keys(obj).forEach(key => {
        cloned[key] = utils.deepClone(obj[key]);
      });
      return cloned;
    }
  },

  // Generate UUID
  generateUUID: () => {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, (c) => {
      const r = Math.random() * 16 | 0;
      const v = c == 'x' ? r : (r & 0x3 | 0x8);
      return v.toString(16);
    });
  },

  // Validate email
  isValidEmail: (email) => {
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(email);
  },

  // Format date
  formatDate: (date, options = {}) => {
    const defaultOptions = {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    };
    return new Intl.DateTimeFormat('en-US', { ...defaultOptions, ...options }).format(new Date(date));
  }
};

// Async data fetcher with error handling
export const apiClient = {
  async get(url, options = {}) {
    try {
      const response = await fetch(url, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          ...options.headers
        },
        ...options
      });

      if (!response.ok) {
        throw new Error(\`HTTP error! status: \${response.status}\`);
      }

      return await response.json();
    } catch (error) {
      console.error('API GET error:', error);
      throw error;
    }
  },

  async post(url, data, options = {}) {
    try {
      const response = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          ...options.headers
        },
        body: JSON.stringify(data),
        ...options
      });

      if (!response.ok) {
        throw new Error(\`HTTP error! status: \${response.status}\`);
      }

      return await response.json();
    } catch (error) {
      console.error('API POST error:', error);
      throw error;
    }
  }
};
\`\`\``;

        } else if (lowerMessage.includes('style') || lowerMessage.includes('css')) {
          return `ü§ñ **CSS Styles Generation**

Creating modern CSS styles:

\`\`\`css
/* Modern CSS Utilities */
.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 20px;
}

.flex {
  display: flex;
}

.flex-center {
  display: flex;
  align-items: center;
  justify-content: center;
}

.grid {
  display: grid;
  gap: 1rem;
}

.grid-cols-2 {
  grid-template-columns: repeat(2, 1fr);
}

.grid-cols-3 {
  grid-template-columns: repeat(3, 1fr);
}

/* Button styles */
.btn {
  padding: 0.5rem 1rem;
  border: none;
  border-radius: 0.375rem;
  cursor: pointer;
  font-weight: 500;
  transition: all 0.2s;
}

.btn-primary {
  background-color: #3b82f6;
  color: white;
}

.btn-primary:hover {
  background-color: #2563eb;
  transform: translateY(-1px);
}

.btn-secondary {
  background-color: #6b7280;
  color: white;
}

.btn-secondary:hover {
  background-color: #4b5563;
}

/* Card component */
.card {
  background: white;
  border-radius: 0.5rem;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  overflow: hidden;
  transition: transform 0.2s, box-shadow 0.2s;
}

.card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.card-header {
  padding: 1rem;
  border-bottom: 1px solid #e5e7eb;
}

.card-body {
  padding: 1rem;
}

.card-footer {
  padding: 1rem;
  background-color: #f9fafb;
  border-top: 1px solid #e5e7eb;
}

/* Form styles */
.form-group {
  margin-bottom: 1rem;
}

.form-label {
  display: block;
  margin-bottom: 0.25rem;
  font-weight: 500;
  color: #374151;
}

.form-input {
  width: 100%;
  padding: 0.5rem;
  border: 1px solid #d1d5db;
  border-radius: 0.375rem;
  transition: border-color 0.2s;
}

.form-input:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

/* Animations */
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.animate-fadeIn {
  animation: fadeIn 0.3s ease-out;
}

@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}

.animate-spin {
  animation: spin 1s linear infinite;
}

/* Responsive utilities */
@media (max-width: 768px) {
  .grid-cols-3 {
    grid-template-columns: 1fr;
  }
  
  .grid-cols-2 {
    grid-template-columns: 1fr;
  }
  
  .container {
    padding: 0 16px;
  }
}
\`\`\``;

        } else {
          return `ü§ñ **Claudy at Your Service**

I can generate code for you! Here are some examples:

**Try asking me:**
- "Create a React component for user profile"
- "Generate utility functions for data handling"
- "Write CSS styles for a modern card component"
- "Create an API service with error handling"
- "Build a form validation hook"

**File targeting syntax:**
Use \`file: path/to/file.js\` before code blocks to specify where to place the code.

**Example:**
"Create a header component"
‚Üí I'll generate both JSX and CSS files for you!

What would you like me to build? üõ†Ô∏è`;
        }
      };

      // File operations continued...
      const renameItem = (item, newName) => {
        const updateInTree = (tree) => {
          return tree.map(treeItem => {
            if (treeItem.id === item.id) {
              return { ...treeItem, name: newName };
            }
            if (treeItem.children) {
              return { ...treeItem, children: updateInTree(treeItem.children) };
            }
            return treeItem;
          });
        };
        setFileTree(updateInTree);

        setOpenTabs(tabs => tabs.map(tab => 
          tab.id === item.id ? { ...tab, name: newName } : tab
        ));
        
        if (activeTab?.id === item.id) {
          setActiveTab({ ...activeTab, name: newName });
        }
      };

      const deleteItem = (item) => {
        const removeFromTree = (tree) => {
          return tree.filter(treeItem => {
            if (treeItem.id === item.id) return false;
            if (treeItem.children) {
              treeItem.children = removeFromTree(treeItem.children);
            }
            return true;
          });
        };
        
        setFileTree(removeFromTree);
        setOpenTabs(tabs => tabs.filter(tab => tab.id !== item.id));
        
        if (activeTab?.id === item.id) {
          const remainingTabs = openTabs.filter(tab => tab.id !== item.id);
          setActiveTab(remainingTabs.length > 0 ? remainingTabs[0] : null);
        }
      };

      // Tab management
      const openFile = (file) => {
        if (file.type !== 'file') return;
        
        const existingTab = openTabs.find(tab => tab.id === file.id);
        if (existingTab) {
          setActiveTab(existingTab);
          return;
        }

        const newTab = { ...file };
        setOpenTabs([...openTabs, newTab]);
        setActiveTab(newTab);
      };

      const closeTab = (tab) => {
        const newTabs = openTabs.filter(t => t.id !== tab.id);
        setOpenTabs(newTabs);
        
        if (activeTab?.id === tab.id) {
          setActiveTab(newTabs.length > 0 ? newTabs[newTabs.length - 1] : null);
        }
      };

      const toggleFolder = (folder) => {
        const updateInTree = (tree) => {
          return tree.map(item => {
            if (item.id === folder.id) {
              return { ...item, expanded: !item.expanded };
            }
            if (item.children) {
              return { ...item, children: updateInTree(item.children) };
            }
            return item;
          });
        };
        setFileTree(updateInTree);
      };

      // Proposal actions
      const applyProposal = (proposal, action) => {
        const targetPath = proposal.file || activeTab?.name || '';
        
        if (action === 'apply') {
          // Overwrite entire file
          const file = findFileByName(fileTree, targetPath);
          if (file) {
            updateFileContent(file.id, proposal.code);
          } else {
            // Create new file
            const parentId = fileTree[0]?.id; // Root folder
            createFile(parentId, targetPath, proposal.code);
          }
        } else if (action === 'insert') {
          // Insert at cursor position
          if (monacoRef.current && activeTab) {
            const editor = monacoRef.current;
            const selection = editor.getSelection();
            editor.executeEdits('ai-insert', [{
              range: selection,
              text: proposal.code
            }]);
            updateFileContent(activeTab.id, editor.getValue());
          }
        } else if (action === 'create') {
          // Create new file with custom path
          const customPath = prompt('Enter file path:', proposal.file || 'new-file.txt');
          if (customPath) {
            const parentId = fileTree[0]?.id; // Root folder
            createFile(parentId, customPath, proposal.code);
          }
        }
        
        // Remove proposal after applying
        setProposals(prev => prev.filter(p => p.id !== proposal.id));
        setSelectedProposal(null);
      };

      // Context menu handlers
      const handleRightClick = (e, item) => {
        e.preventDefault();
        setContextMenu({
          x: e.pageX,
          y: e.pageY,
          item
        });
      };

      const handleContextAction = (action, item) => {
        setContextMenu(null);
        
        switch (action) {
          case 'add-file':
            const fileName = prompt('Enter file name:');
            if (fileName) {
              createFile(item.id, fileName);
            }
            break;
            
          case 'add-folder':
            const folderName = prompt('Enter folder name:');
            if (folderName) {
              createFolder(item.id, folderName);
            }
            break;
            
          case 'rename':
            const newName = prompt('Enter new name:', item.name);
            if (newName && newName !== item.name) {
              renameItem(item, newName);
            }
            break;
            
          case 'delete':
            if (confirm(`Delete "${item.name}"?`)) {
              deleteItem(item);
            }
            break;
            
          case 'run-preview':
            if (item.name.endsWith('.html')) {
              updatePreview(item.content || '');
              setRightPanel('preview');
            }
            break;
            
          case 'execute-script':
            if (item.name.endsWith('.js')) {
              executeScript(item.content || '');
              setRightPanel('preview');
            }
            break;
        }
      };

      // Preview functions
      const updatePreview = (htmlContent) => {
        if (previewFrameRef.current) {
          const iframe = previewFrameRef.current;
          const doc = iframe.contentDocument || iframe.contentWindow.document;
          doc.open();
          doc.write(htmlContent);
          doc.close();
          
          // Inject console capture
          iframe.contentWindow.console = {
            log: (...args) => {
              setConsoleOutput(prev => [...prev, { 
                type: 'log', 
                content: args.map(arg => typeof arg === 'object' ? JSON.stringify(arg) : arg).join(' '),
                timestamp: new Date().toLocaleTimeString()
              }]);
            },
            error: (...args) => {
              setConsoleOutput(prev => [...prev, { 
                type: 'error', 
                content: args.map(arg => typeof arg === 'object' ? JSON.stringify(arg) : arg).join(' '),
                timestamp: new Date().toLocaleTimeString()
              }]);
            },
            warn: (...args) => {
              setConsoleOutput(prev => [...prev, { 
                type: 'warn', 
                content: args.map(arg => typeof arg === 'object' ? JSON.stringify(arg) : arg).join(' '),
                timestamp: new Date().toLocaleTimeString()
              }]);
            }
          };
        }
      };

      const executeScript = (jsContent) => {
        try {
          setConsoleOutput([]);
          
          // Capture console output
          const originalLog = console.log;
          const originalError = console.error;
          const originalWarn = console.warn;
          
          console.log = (...args) => {
            setConsoleOutput(prev => [...prev, { 
              type: 'log', 
              content: args.map(arg => typeof arg === 'object' ? JSON.stringify(arg, null, 2) : arg).join(' '),
              timestamp: new Date().toLocaleTimeString()
            }]);
            originalLog(...args);
          };
          
          console.error = (...args) => {
            setConsoleOutput(prev => [...prev, { 
              type: 'error', 
              content: args.map(arg => typeof arg === 'object' ? JSON.stringify(arg, null, 2) : arg).join(' '),
              timestamp: new Date().toLocaleTimeString()
            }]);
            originalError(...args);
          };
          
          console.warn = (...args) => {
            setConsoleOutput(prev => [...prev, { 
              type: 'warn', 
              content: args.map(arg => typeof arg === 'object' ? JSON.stringify(arg, null, 2) : arg).join(' '),
              timestamp: new Date().toLocaleTimeString()
            }]);
            originalWarn(...args);
          };

          // Execute script
          eval(jsContent);

          // Restore console
          setTimeout(() => {
            console.log = originalLog;
            console.error = originalError;
            console.warn = originalWarn;
          }, 100);
          
        } catch (error) {
          setConsoleOutput(prev => [...prev, { 
            type: 'error', 
            content: error.message,
            timestamp: new Date().toLocaleTimeString()
          }]);
        }
      };

      // Initialize Monaco Editor
      useEffect(() => {
        const initMonaco = () => {
          if (editorRef.current && !monacoRef.current) {
            monacoRef.current = monaco.editor.create(editorRef.current, {
              value: '',
              language: 'javascript',
              theme: 'vs-dark',
              automaticLayout: true,
              fontSize: 13,
              lineNumbers: 'on',
              minimap: { enabled: false },
              padding: { top: 16 },
              scrollBeyondLastLine: false,
              wordWrap: 'on'
            });

            // Auto-save on change
            monacoRef.current.onDidChangeModelContent(() => {
              if (activeTab) {
                const content = monacoRef.current.getValue();
                updateFileContent(activeTab.id, content);
                
                // Auto-preview HTML files
                if (activeTab.name.endsWith('.html')) {
                  updatePreview(content);
                }
              }
            });
          }
        };

        if (window.monaco) {
          initMonaco();
        } else {
          require(['vs/editor/editor.main'], initMonaco);
        }

        // Auto-open index.html
        const indexFile = findFileByName(fileTree, 'index.html');
        if (indexFile && openTabs.length === 0) {
          openFile(indexFile);
        }
      }, []);

      // Update editor when active tab changes
      useEffect(() => {
        if (monacoRef.current && activeTab) {
          const language = getLanguageFromFilename(activeTab.name);
          const model = monaco.editor.createModel(activeTab.content || '', language);
          monacoRef.current.setModel(model);
          
          if (activeTab.name.endsWith('.html')) {
            updatePreview(activeTab.content || '');
          }
        }
      }, [activeTab]);

      // Hide context menu on click
      useEffect(() => {
        const handleClick = () => setContextMenu(null);
        document.addEventListener('click', handleClick);
        return () => document.removeEventListener('click', handleClick);
      }, []);

      // Auto-save to localStorage
      useEffect(() => {
        localStorage.setItem('icoder-project-v2.1.1', JSON.stringify(fileTree));
      }, [fileTree]);

      // Load from localStorage
      useEffect(() => {
        const saved = localStorage.getItem('icoder-project-v2.1.1');
        if (saved) {
          try {
            const project = JSON.parse(saved);
            setFileTree(project);
          } catch (e) {
            console.warn('Failed to load project:', e);
          }
        }
      }, []);

      // Render tree recursively
      const renderTreeItem = (item, level = 0) => {
        const isSelected = activeTab?.id === item.id;
        const isDragging = draggedItem?.id === item.id;

        return (
          <div key={item.id} style={{ marginLeft: level * 12 }}>
            <div
              className={`tree-item ${item.type} ${isSelected ? 'selected' : ''} ${isDragging ? 'dragging' : ''}`}
              draggable={item.type === 'file' || (item.type === 'folder' && level > 0)}
              onClick={() => {
                if (item.type === 'folder') {
                  toggleFolder(item);
                } else {
                  openFile(item);
                }
              }}
              onContextMenu={(e) => handleRightClick(e, item)}
              onDragStart={(e) => handleDragStart(e, item)}
              onDragOver={item.type === 'folder' ? handleDragOver : undefined}
              onDrop={item.type === 'folder' ? (e) => handleDrop(e, item) : undefined}
            >
              {item.type === 'folder' && (
                <span className={`tree-arrow ${item.expanded ? 'expanded' : ''}`}>
                  ‚ñ∫
                </span>
              )}
              <span className="tree-icon">
                {item.type === 'folder' ? 'üìÇ' : getFileIcon(item.name)}
              </span>
              <span>{item.name}</span>
            </div>
            
            {item.type === 'folder' && item.expanded && item.children && (
              <div className="tree-children">
                {item.children.map(child => renderTreeItem(child, level + 1))}
              </div>
            )}
          </div>
        );
      };

      return (
        <div className="app">
          {/* Top Bar */}
          <div className="topbar">
            <div className="brand">
              <span style={{ fontSize: 22 }}>‚ö° iCoder Plus v2.1.1</span>
              <span className="badge">Dual-Agent AI IDE</span>
            </div>
            
            <div className="dual-agent-indicator">
              <div className={`agent-dot ${agent}`}></div>
              <span>Active: {agent === 'dashka' ? 'Dashka (Architect)' : 'Claudy (Code Gen)'}</span>
            </div>
          </div>

          <div className="main">
            {/* File Tree */}
            <div className="file-tree">
              <div className="tree-header">
                <span style={{ fontWeight: 600, fontSize: 13 }}>üìÅ Project Files</span>
                <div className="tree-controls">
                  <button 
                    className="tree-btn" 
                    onClick={() => {
                      const name = prompt('New project name:');
                      if (name) {
                        setFileTree([{
                          id: generateId(),
                          name,
                          type: 'folder',
                          expanded: true,
                          children: []
                        }]);
                        setOpenTabs([]);
                        setActiveTab(null);
                        setProposals([]);
                      }
                    }}
                    title="New Project"
                  >
                    üÜï
                  </button>
                  <button 
                    className="tree-btn"
                    onClick={exportProjectAsZip}
                    title="Export Project as ZIP"
                  >
                    üì§
                  </button>
                </div>
              </div>

              <div className="search-box">
                <input
                  type="text"
                  className="search-input"
                  placeholder="üîç Search files..."
                  value={searchQuery}
                  onChange={(e) => setSearchQuery(e.target.value)}
                />
              </div>

              <div className="tree-content">
                {fileTree
                  .filter(item => 
                    searchQuery === '' || 
                    item.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
                    (item.children && JSON.stringify(item.children).toLowerCase().includes(searchQuery.toLowerCase()))
                  )
                  .map(item => renderTreeItem(item))
                }
              </div>
            </div>

            {/* Editor Area */}
            <div className="editor-area">
              {/* Editor Tabs */}
              <div className="editor-tabs">
                {openTabs.map(tab => (
                  <div
                    key={tab.id}
                    className={`editor-tab ${activeTab?.id === tab.id ? 'active' : ''}`}
                    onClick={() => setActiveTab(tab)}
                  >
                    <span className="tree-icon">{getFileIcon(tab.name)}</span>
                    <span>{tab.name}</span>
                    <span 
                      className="tab-close"
                      onClick={(e) => {
                        e.stopPropagation();
                        closeTab(tab);
                      }}
                    >
                      √ó
                    </span>
                  </div>
                ))}
                
                {openTabs.length === 0 && (
                  <div style={{ padding: '12px 16px', color: 'var(--muted)', fontSize: '12px' }}>
                    üëà Open a file from the tree to start coding
                  </div>
                )}
              </div>

              {/* Monaco Editor */}
              <div className="editor-container">
                <div ref={editorRef} id="monaco-editor"></div>
              </div>
            </div>

            {/* Right Panel - Dual Agent AI */}
            <div className="right-panel">
              <div className="panel-tabs">
                <div 
                  className={`panel-tab ${rightPanel === 'ai-chat' ? 'active' : ''}`}
                  onClick={() => setRightPanel('ai-chat')}
                >
                  ü§ñ Dual AI
                </div>
                <div 
                  className={`panel-tab ${rightPanel === 'preview' ? 'active' : ''}`}
                  onClick={() => setRightPanel('preview')}
                >
                  ‚ñ∂ Preview
                </div>
              </div>

              <div className="panel-content">
                {rightPanel === 'ai-chat' && (
                  <div className="ai-chat-panel">
                    {/* Agent Selector */}
                    <div className="agent-selector">
                      <div
                        className={`agent-option dashka ${agent === <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>iCoder Plus v2.1.1 - Dual-Agent AI IDE</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/monaco-editor@0.44.0/min/vs/loader.js"></script>
  <script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    :root {
      --bg: #0d1117;
      --surface: #161b22;
      --panel: #21262d;
      --border: #30363d;
      --text: #e6edf3;
      --muted: #7d8590;
      --primary: #238636;
      --accent: #1f6feb;
      --warning: #f85149;
      --success: #28a745;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      overflow: hidden;
    }
    
    .app {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 16px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      min-height: 50px;
    }
    
    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 600;
    }
    
    .badge {
      padding: 4px 8px;
      background: var(--panel);
      border-radius: 6px;
      font-size: 12px;
      color: var(--muted);
    }
    
    .dual-agent-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 8px;
      background: var(--panel);
      border-radius: 6px;
      font-size: 11px;
    }
    
    .agent-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent);
    }
    
    .agent-dot.dashka { background: #ff6b35; }
    .agent-dot.claudy { background: #4ecdc4; }
    
    .main {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    
    /* File Tree Panel */
    .file-tree {
      width: 280px;
      background: var(--surface);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
    }
    
    .tree-header {
      padding: 12px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .tree-controls {
      display: flex;
      gap: 4px;
    }
    
    .tree-btn {
      padding: 4px 8px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      cursor: pointer;
      font-size: 11px;
      transition: all 0.2s;
    }
    
    .tree-btn:hover {
      background: var(--accent);
    }
    
    .search-box {
      padding: 8px 12px;
      border-bottom: 1px solid var(--border);
    }
    
    .search-input {
      width: 100%;
      padding: 6px 8px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      font-size: 12px;
    }
    
    .tree-content {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }
    
    .tree-item {
      display: flex;
      align-items: center;
      padding: 4px 8px;
      margin: 1px 0;
      cursor: pointer;
      border-radius: 4px;
      font-size: 13px;
      user-select: none;
      transition: all 0.15s;
      position: relative;
    }
    
    .tree-item:hover {
      background: var(--panel);
    }
    
    .tree-item.selected {
      background: var(--accent);
      color: white;
    }
    
    .tree-item.folder {
      font-weight: 500;
    }
    
    .tree-item.dragging {
      opacity: 0.5;
    }
    
    .tree-item.drag-over {
      background: rgba(31, 111, 235, 0.2);
      border: 1px dashed var(--accent);
    }
    
    .tree-icon {
      margin-right: 6px;
      font-size: 14px;
    }
    
    .tree-arrow {
      margin-right: 4px;
      font-size: 10px;
      transition: transform 0.2s;
    }
    
    .tree-arrow.expanded {
      transform: rotate(90deg);
    }
    
    .tree-children {
      margin-left: 16px;
    }
    
    /* Context Menu */
    .context-menu {
      position: absolute;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 1000;
      min-width: 180px;
      padding: 4px;
    }
    
    .context-item {
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 4px;
      font-size: 12px;
      transition: background 0.15s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .context-item:hover {
      background: var(--accent);
    }
    
    .context-divider {
      height: 1px;
      background: var(--border);
      margin: 4px 0;
    }
    
    /* Editor Area */
    .editor-area {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    .editor-tabs {
      display: flex;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      overflow-x: auto;
    }
    
    .editor-tab {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      cursor: pointer;
      border-right: 1px solid var(--border);
      font-size: 12px;
      min-width: 120px;
      transition: all 0.2s;
    }
    
    .editor-tab:hover {
      background: var(--panel);
    }
    
    .editor-tab.active {
      background: var(--bg);
      border-bottom: 2px solid var(--accent);
    }
    
    .tab-close {
      padding: 2px;
      border-radius: 2px;
      opacity: 0.6;
      transition: all 0.2s;
      font-size: 10px;
    }
    
    .tab-close:hover {
      opacity: 1;
      background: var(--warning);
      color: white;
    }
    
    .editor-container {
      flex: 1;
      position: relative;
    }
    
    #monaco-editor {
      width: 100%;
      height: 100%;
    }
    
    /* Right Panel - Dual Agent AI */
    .right-panel {
      width: 400px;
      background: var(--surface);
      border-left: 1px solid var(--border);
      display: flex;
      flex-direction: column;
    }
    
    .panel-tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
    }
    
    .panel-tab {
      flex: 1;
      padding: 8px;
      text-align: center;
      cursor: pointer;
      font-size: 11px;
      background: var(--panel);
      border-right: 1px solid var(--border);
      transition: all 0.2s;
      font-weight: 500;
    }
    
    .panel-tab:last-child {
      border-right: none;
    }
    
    .panel-tab.active {
      background: var(--surface);
      border-bottom: 2px solid var(--accent);
    }
    
    .panel-content {
      flex: 1;
      padding: 12px;
      overflow-y: auto;
    }
    
    /* Dual Agent UI */
    .agent-selector {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .agent-option {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      cursor: pointer;
      text-align: center;
      font-size: 11px;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .agent-option.dashka {
      border-color: #ff6b35;
      color: #ff6b35;
    }
    
    .agent-option.claudy {
      border-color: #4ecdc4;
      color: #4ecdc4;
    }
    
    .agent-option.active.dashka {
      background: #ff6b35;
      color: white;
    }
    
    .agent-option.active.claudy {
      background: #4ecdc4;
      color: white;
    }
    
    .target-selector {
      margin-bottom: 12px;
    }
    
    .target-select {
      width: 100%;
      padding: 6px 8px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      font-size: 11px;
    }
    
    .chat-input-area {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .chat-input {
      flex: 1;
      padding: 8px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      font-size: 12px;
      resize: vertical;
      min-height: 60px;
    }
    
    .chat-send {
      padding: 8px 12px;
      background: var(--primary);
      border: none;
      border-radius: 4px;
      color: white;
      cursor: pointer;
      font-size: 12px;
      height: fit-content;
    }
    
    .chat-send:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* Proposals Section */
    .proposals-section {
      border-top: 1px solid var(--border);
      padding-top: 12px;
    }
    
    .proposals-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .proposals-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
    }
    
    .proposals-count {
      font-size: 10px;
      padding: 2px 6px;
      background: var(--accent);
      border-radius: 10px;
      color: white;
    }
    
    .proposal-item {
      padding: 8px;
      margin-bottom: 8px;
      background: var(--panel);
      border-radius: 4px;
      border-left: 3px solid var(--accent);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .proposal-item:hover {
      background: var(--border);
    }
    
    .proposal-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 4px;
    }
    
    .proposal-title {
      font-size: 12px;
      font-weight: 600;
    }
    
    .proposal-meta {
      font-size: 10px;
      color: var(--muted);
    }
    
    .proposal-actions {
      display: flex;
      gap: 4px;
      margin-top: 8px;
    }
    
    .proposal-btn {
      padding: 4px 8px;
      border: 1px solid var(--border);
      border-radius: 3px;
      background: var(--panel);
      color: var(--text);
      cursor: pointer;
      font-size: 10px;
      transition: all 0.2s;
    }
    
    .proposal-btn.apply { border-color: var(--success); color: var(--success); }
    .proposal-btn.insert { border-color: var(--accent); color: var(--accent); }
    .proposal-btn.create { border-color: var(--warning); color: var(--warning); }
    
    .proposal-btn:hover.apply { background: var(--success); color: white; }
    .proposal-btn:hover.insert { background: var(--accent); color: white; }
    .proposal-btn:hover.create { background: var(--warning); color: white; }
    
    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    
    .modal-content {
      width: min(900px, 90vw);
      max-height: 80vh;
      overflow: auto;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .modal-title {
      font-weight: 600;
      font-size: 14px;
    }
    
    .modal-actions {
      display: flex;
      gap: 8px;
    }
    
    .code-preview {
      background: var(--panel);
      border-radius: 4px;
      padding: 12px;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 11px;
      line-height: 1.4;
      overflow-x: auto;
      white-space: pre-wrap;
    }
    
    /* Preview Panel */
    .preview-frame {
      width: 100%;
      height: 300px;
      border: 1px solid var(--border);
      border-radius: 4px;
      background: white;
    }
    
    .console-output {
      margin-top: 12px;
      padding: 8px;
      background: var(--bg);
      border-radius: 4px;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 10px;
      max-height: 150px;
      overflow-y: auto;
    }
    
    .console-log { color: var(--text); }
    .console-error { color: var(--warning); }
    .console-warn { color: #ffa500; }
    
    /* Export Progress */
    .export-progress {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--panel);
      padding: 20px;
      border-radius: 8px;
      border: 1px solid var(--border);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 10000;
      text-align: center;
    }
    
    .progress-bar {
      width: 200px;
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      margin: 10px 0;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: var(--accent);
      border-radius: 2px;
      transition: width 0.3s ease;
    }
    
    /* Utility classes */
    .btn {
      padding: 6px 12px;
      border: 1px solid var(--border);
      border-radius: 4px;
      background: var(--panel);
      color: var(--text);
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }
    
    .btn:hover {
      background: var(--accent);
      color: white;
    }
    
    .btn.primary {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    .btn.warning {
      background: var(--warning);
      color: white;
      border-color: var(--warning);
    }
    
    .muted { color: var(--muted); font-size: 11px; }
    .hidden { display: none !important; }
    
    /* Scrollbars */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    
    ::-webkit-scrollbar-track {
      background: var(--panel);
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--muted);
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    // File type icons
    const getFileIcon = (name) => {
      const ext = name.split('.').pop()?.toLowerCase();
      const icons = {
        html: 'üü•', htm: 'üü•',
        js: 'üü¶', jsx: 'üü¶', mjs: 'üü¶',
        ts: 'üü®', tsx: 'üü®',
        css: 'üü™', scss: 'üü™', less: 'üü™',
        json: 'üü©', jsonc: 'üü©',
        md: 'üìù', txt: 'üìù',
        png: 'üñºÔ∏è', jpg: 'üñºÔ∏è', gif: 'üñºÔ∏è', svg: 'üñºÔ∏è',
        zip: 'üì¶', rar: 'üì¶',
      };
      return icons[ext] || 'üìÑ';
    };

    // Language detection
    const getLanguageFromFilename = (filename) => {
      const ext = filename.split('.').pop()?.toLowerCase();
      const langMap = {
        html: 'html', htm: 'html',
        js: 'javascript', jsx: 'javascript', mjs: 'javascript',
        ts: 'typescript', tsx: 'typescript',
        css: 'css', scss: 'scss', less: 'less',
        json: 'json', jsonc: 'json',
        md: 'markdown', txt: 'plaintext'
      };
      return langMap[ext] || 'plaintext';
    };

    // Initial project structure
    const initialFiles = [
      {
        id: 'root',
        name: 'My Project',
        type: 'folder',
        expanded: true,
        children: [
          {
            id: 'index-html',
            name: 'index.html',
            type: 'file',
            content: `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iCoder Plus v2.1.1 - Dual Agent IDE</title>
    <link rel="stylesheet" href="styles/main.css">
</head>
<body>
    <div class="container">
        <header class="hero">
            <h1>üöÄ Welcome to iCoder Plus v2.1.1!</h1>
            <p class="subtitle">Your <strong>Dual-Agent AI IDE</strong> is ready!</p>
        </header>
        
        <main class="content">
            <div class="feature-grid">
                <div class="feature-card">
                    <h3>üèóÔ∏è Dashka Mode</h3>
                    <p>Architecture advice and code review</p>
                </div>
                <div class="feature-card">
                    <h3>ü§ñ Claudy Mode</h3>
                    <p>Code generation and automatic insertion</p>
                </div>
            </div>
            
            <div class="demo-section">
                <button class="btn primary" onclick="showDemo()">Try Demo</button>
                <button class="btn secondary" onclick="runTests()">Run Tests</button>
            </div>
            
            <div id="output" class="output-area"></div>
        </main>
    </div>
    
    <script src="app.js"></script>
</body>
</html>`
          },
          {
            id: 'app-js',
            name: 'app.js',
            type: 'file',
            content: `// iCoder Plus v2.1.1 - Dual Agent AI IDE
console.log('üöÄ iCoder Plus v2.1.1 loaded successfully!');

// Demo functions
function showDemo() {
    const output = document.getElementById('output');
    output.innerHTML = \`
        <div class="demo-result">
            <h3>‚ú® Dual-Agent AI Demo</h3>
            <div class="agent-showcase">
                <div class="agent-demo dashka">
                    <h4>üèóÔ∏è Dashka</h4>
                    <p>"I analyze your code architecture and provide strategic guidance."</p>
                </div>
                <div class="agent-demo claudy">
                    <h4>ü§ñ Claudy</h4> 
                    <p>"I generate ready-to-use code and insert it directly into your files."</p>
                </div>
            </div>
            <p class="demo-tip">üí° Try asking Claudy: "Create a React component" or Dashka: "Review this code structure"</p>
        </div>
    \`;
    console.log('Demo displayed successfully!');
}

function runTests() {
    const output = document.getElementById('output');
    let testResults = [];
    
    // Test 1: File tree functionality
    try {
        console.log('Testing file operations...');
        testResults.push('‚úÖ File tree operations: PASS');
    } catch (e) {
        testResults.push('‚ùå File tree operations: FAIL');
    }
    
    // Test 2: Monaco Editor
    try {
        console.log('Testing Monaco Editor integration...');
        testResults.push('‚úÖ Monaco Editor: PASS');
    } catch (e) {
        testResults.push('‚ùå Monaco Editor: FAIL'); 
    }
    
    // Test 3: Dual Agent System
    try {
        console.log('Testing Dual Agent system...');
        testResults.push('‚úÖ Dual Agent AI: PASS');
    } catch (e) {
        testResults.push('‚ùå Dual Agent AI: FAIL');
    }
    
    output.innerHTML = \`
        <div class="test-results">
            <h3>üß™ Test Results</h3>
            <ul>
                \${testResults.map(result => \`<li>\${result}</li>\`).join('')}
            </ul>
            <p class="test-summary">Tests completed at: \${new Date().toLocaleTimeString()}</p>
        </div>
    \`;
}

// Auto-initialization
document.addEventListener('DOMContentLoaded', () => {
    console.log('üéØ iCoder Plus v2.1.1 ready for dual-agent AI assistance!');
    
    // Add interaction effects
    const buttons = document.querySelectorAll('button');
    buttons.forEach(btn => {
        btn.addEventListener('mouseenter', () => {
            console.log(\`Button hover: \${btn.textContent}\`);
        });
        
        btn.addEventListener('click', (e) => {
            console.log(\`Button clicked: \${btn.textContent}\`);
        });
    });
    
    // Initialize feature cards animation
    const cards = document.querySelectorAll('.feature-card');
    cards.forEach((card, index) => {
        setTimeout(() => {
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 200);
    });
});`
          },
          {
            id: 'styles-folder',
            name: 'styles',
            type: 'folder',
            expanded: true,
            children: [
              {
                id: 'main-css',
                name: 'main.css',
                type: 'file',
                content: `/* iCoder Plus v2.1.1 - Enhanced Styles */
:root {
    --primary: #1f6feb;
    --primary-dark: #1557d0;
    --secondary: #6c757d;
    --success: #28a745;
    --warning: #ffc107;
    --danger: #dc3545;
    --bg: #ffffff;
    --surface: #f8f9fa;
    --text: #212529;
    --text-muted: #6c757d;
    --border: #dee2e6;
    --shadow: rgba(0,0,0,0.1);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    line-height: 1.6;
    color: var(--text);
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 40px 20px;
    background: var(--bg);
    border-radius: 16px;
    box-shadow: 0 20px 40px var(--shadow);
    margin-top: 20px;
    margin-bottom: 20px;
}

.hero {
    text-align: center;
    margin-bottom: 40px;
    padding: 20px 0;
}

.hero h1 {
    font-size: 3em;
    color: var(--primary);
    margin-bottom: 10px;
    font-weight: 700;
}

.subtitle {
    font-size: 1.3em;
    color: var(--text-muted);
    margin-bottom: 20px;
}

.content {
    max-width: 900px;
    margin: 0 auto;
}

.feature-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 24px;
    margin-bottom: 40px;
}

.feature-card {
    background: var(--surface);
    padding: 24px;
    border-radius: 12px;
    border-left: 4px solid var(--primary);
    box-shadow: 0 4px 12px var(--shadow);
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.3s ease;
}

.feature-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px var(--shadow);
}

.feature-card h3 {
    font-size: 1.4em;
    margin-bottom: 8px;
    color: var(--primary);
}

.feature-card p {
    color: var(--text-muted);
    font-size: 1.1em;
}

.demo-section {
    text-align: center;
    margin: 40px 0;
}

.btn {
    display: inline-block;
    padding: 12px 24px;
    font-size: 16px;
    font-weight: 600;
    text-decoration: none;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    margin: 8px;
    box-shadow: 0 2px 8px var(--shadow);
}

.btn.primary {
    background: var(--primary);
    color: white;
}

.btn.primary:hover {
    background: var(--primary-dark);
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(31, 111, 235, 0.3);
}

.btn.secondary {
    background: var(--secondary);
    color: white;
}

.btn.secondary:hover {
    background: #5a6268;
    transform: translateY(-2px);
}

.output-area {
    margin-top: 30px;
    min-height: 100px;
}

.demo-result {
    background: var(--surface);
    padding: 24px;
    border-radius: 12px;
    border: 1px solid var(--border);
    margin-top: 20px;
}

.demo-result h3 {
    color: var(--primary);
    margin-bottom: 16px;
}

.agent-showcase {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 16px;
    margin: 20px 0;
}

.agent-demo {
    padding: 16px;
    border-radius: 8px;
    text-align: left;
}

.agent-demo.dashka {
    background: rgba(255, 107, 53, 0.1);
    border-left: 4px solid #ff6b35;
}

.agent-demo.claudy {
    background: rgba(78, 205, 196, 0.1);
    border-left: 4px solid #4ecdc4;
}

.agent-demo h4 {
    margin-bottom: 8px;
    font-size: 1.2em;
}

.agent-demo.dashka h4 {
    color: #ff6b35;
}

.agent-demo.claudy h4 {
    color: #4ecdc4;
}

.demo-tip {
    text-align: center;
    margin-top: 16px;
    font-style: italic;
    color: var(--text-muted);
}

.test-results {
    background: var(--surface);
    padding: 24px;
    border-radius: 12px;
    border: 1px solid var(--border);
    margin-top: 20px;
}

.test-results h3 {
    color: var(--primary);
    margin-bottom: 16px;
}

.test-results ul {
    list-style: none;
    margin: 16px 0;
}

.test-results li {
    padding: 4px 0;
    font-family: 'Monaco', 'Menlo', monospace;
    font-size: 14px;
}

.test-summary {
    margin-top: 16px;
    font-size: 12px;
    color: var(--text-muted);
    text-align: center;
}

@media (max-width: 768px) {
    .hero h1 {
        font-size: 2.2em;
    }
    
    .container {
        margin: 10px;
        padding: 20px;
    }
    
    .feature-grid {
        grid-template-columns: 1fr;
        gap: 16px;
    }
}`
              }
            ]
          },
          {
            id: 'components-folder',
            name: 'components',
            type: 'folder',
            expanded: false,
            children: [
              {
                id: 'header-jsx',
                name: 'Header.jsx',
                type: 'file',
                content: `// Header Component - Generated by Claudy
import React from 'react';

const Header = ({ title, subtitle, onMenuClick }) => {
  return (
    <header className="app-header">
      <div className="header-content">
        <div className="header-brand">
          <h1>{title || 'iCoder Plus'}</h1>
          {subtitle && <p className="header-subtitle">{subtitle}</p>}
        </div>
        
        <nav className="header-nav">
          <button 
            className="nav-btn"
            onClick={onMenuClick}
            aria-label="Toggle menu"
          >
            ‚ò∞
          </button>
        </nav>
      </div>
    </header>
  );
};

export default Header;`
              }
            ]
          }
        ]
      }
    ];

    // Main App Component
    function App() {
      // File tree and editor state
      const [fileTree, setFileTree] = useState(initialFiles);
      const [openTabs, setOpenTabs] = useState([]);
      const [activeTab, setActiveTab] = useState(null);
      const [searchQuery, setSearchQuery] = useState('');
      const [rightPanel, setRightPanel] = useState('ai-chat');
      const [contextMenu, setContextMenu] = useState(null);
      
      // Dual Agent AI state
      const [agent, setAgent] = useState('dashka');
      const [targetFile, setTargetFile] = useState('');
      const [proposals, setProposals] = useState([]);
      const [selectedProposal, setSelectedProposal] = useState(null);
      const [chatInput, setChatInput] = useState('');
      const [aiLoading, setAiLoading] = useState(false);
      
      // Preview state
      const [consoleOutput, setConsoleOutput] = useState([]);
      
      // Drag and drop state
      const [draggedItem, setDraggedItem] = useState(null);
      const [exportProgress, setExportProgress] = useState(null);
      
      const editorRef = useRef(null);
      const monacoRef = useRef(null);
      const previewFrameRef = useRef(null);

      // Utility functions
      const generateId = () => Math.random().toString(36).substr(2, 9);

      const findFileById = (tree, id) => {
        for (const item of tree) {
          if (item.id === id) return item;
          if (item.children) {
            const found = findFileById(item.children, id);
            if (found) return found;
          }
        }
        return null;
      };

      const findFileByName = (tree, name) => {
        for (const item of tree) {
          if (item.name === name && item.type === 'file') return item;
          if (item.children) {
            const found = findFileByName(item.children, name);
            if (found) return found;
          }
        }
        return null;
      };

      const getAllFilePaths = (tree, path = '') => {
        let paths = [];
        for (const item of tree) {
          const currentPath = path ? `${path}/${item.name}` : item.name;
          if (item.type === 'file') {
            paths.push(currentPath);
          }
          if (item.children) {
            paths = paths.concat(getAllFilePaths(item.children, currentPath));
          }
        }
        return paths;
      };

      // Export ZIP with progress
      const exportProjectAsZip = async () => {
        if (!window.JSZip || !window.saveAs) {
          alert('Export libraries not loaded. Please refresh and try again.');
          return;
        }

        setExportProgress({ message: 'Preparing export...', progress: 0 });

        try {
          const zip = new JSZip();
          let fileCount = 0;
          let processedCount = 0;

          // Count total files
          const countFiles = (tree) => {
            tree.forEach(item => {
              if (item.type === 'file') fileCount++;
              if (item.children) countFiles(item.children);
            });
          };
          countFiles(fileTree);

          // Add files to ZIP
          const addToZip = (tree, folder = zip) => {
            tree.forEach(item => {
              if (item.type === 'file') {
                folder.file(item.name, item.content || '');
                processedCount++;
                setExportProgress({
                  message: `Adding ${item.name}...`,
                  progress: (processedCount / fileCount) * 100
                });
              } else if (item.type === 'folder' && item.children) {
                const subFolder = folder.folder(item.name);
                addToZip(item.children, subFolder);
              }
            });
          };

          addToZip(fileTree);

          setExportProgress({ message: 'Generating ZIP...', progress: 90 });

          const content = await zip.generateAsync({ type: 'blob' });
          
          setExportProgress({ message: 'Download starting...', progress: 100 });

          // Save file
          const projectName = fileTree[0]?.name || 'iCoder-Project';
          saveAs(content, `${projectName}-${new Date().toISOString().split('T')[0]}.zip`);

          setTimeout(() => setExportProgress(null), 1000);

        } catch (error) {
          console.error('Export failed:', error);
          alert('Export failed: ' + error.message);
          setExportProgress(null);
        }
      };

      // AI Proposals Parser (Enhanced)
      const extractProposalsFromText = (text, targetPath) => {
        const proposals = [];
        
        // Match file-specific blocks with better regex
        const fileBlockRegex = /(?:^|\n)file:\s*([^\n]+)\n```(\w+)?\n([\s\S]*?)```/gi;
        let match;
        
        while ((match = fileBlockRegex.exec(text)) !== null) {
          const [, filePath, language, code] = match;
          proposals.push({
            id: generateId(),
            title: `Update ${filePath}`,
            file: filePath.trim(),
            language: language || 'text',
            code: code.trim(),
            type: 'file-specific'
          });
        }

        // Match general code blocks
        const codeBlockRegex = /```(\w+)?\n([\s\S]*?)```/gi;
        const usedBlocks = new Set();
        
        while ((match = codeBlockRegex.exec(text)) !== null) {
          const [fullMatch, language, code] = match;
          
          // Skip if already captured as file-specific
          if (!text.includes(`file:`) || !fullMatch.includes(code)) {
            if (!usedBlocks.has(fullMatch)) {
              proposals.push({
                id: generateId(),
                title: `Code snippet (${language || 'text'})`,
                file: targetPath || (activeTab?.name) || '',
                language: language || 'text',
                code: code.trim(),
                type: 'code-block'
              });
              usedBlocks.add(fullMatch);
            }
          }
        }

        return proposals;
      };

      // File operations with enhanced functionality
      const updateFileContent = (fileId, content) => {
        const updateInTree = (tree) => {
          return tree.map(item => {
            if (item.id === fileId) {
              return { ...item, content };
            }
            if (item.children) {
              return { ...item, children: updateInTree(item.children) };
            }
            return item;
          });
        };
        
        setFileTree(updateInTree);
        
        // Update open tabs
        setOpenTabs(tabs => tabs.map(tab => 
          tab.id === fileId ? { ...tab, content } : tab
        ));
        
        if (activeTab?.id === fileId) {
          setActiveTab({ ...activeTab, content });
        }
      };

      const createFile = (parentId, name, content = '') => {
        const newFile = {
          id: generateId(),
          name,
          type: 'file',
          content
        };

        const addToTree = (tree) => {
          return tree.map(item => {
            if (item.id === parentId) {
              const children = [...(item.children || []), newFile];
              return {
                ...item,
                children: children.sort((a, b) => {
                  if (a.type !== b.type) return a.type === 'folder' ? -1 : 1;
                  return a.name.localeCompare(b.name);
                })
              };
            }
            if (item.children) {
              return { ...item, children: addToTree(item.children) };
            }
            return item;
          });
        };

        setFileTree(addToTree);
        openFile(newFile);
        return newFile;
      };

      const createFolder = (parentId, name) => {
        const newFolder = {
          id: generateId(),
          name,
          type: 'folder',
          expanded: true,
          children: []
        };

        const addToTree = (tree) => {
          return tree.map(item => {
            if (item.id === parentId) {
              const children = [...(item.children || []), newFolder];
              return {
                ...item,
                children: children.sort((a, b) => {
                  if (a.type !== b.type) return a.type === 'folder' ? -1 : 1;
                  return a.name.localeCompare(b.name);
                })
              };
            }
            if (item.children) {
              return { ...item, children: addToTree(item.children) };
            }
            return item;
          });
        };

        setFileTree(addToTree);
      };

      // Drag and Drop functionality
      const handleDragStart = (e, item) => {
        setDraggedItem(item);
        e.dataTransfer.effectAllowed = 'move';
      };

      const handleDragOver = (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
      };

      const handleDrop = (e, targetItem) => {
        e.preventDefault();
        
        if (!draggedItem || draggedItem.id === targetItem.id) return;
        
        // Can only drop into folders
        if (targetItem.type !== 'folder') return;
        
        // Remove from current location
        const removeFromTree = (tree) => {
          return tree.filter(item => {
            if (item.id === draggedItem.id) return false;
            if (item.children) {
              item.children = removeFromTree(item.children);
            }
            return true;
          });
        };
        
        // Add to new location
        const addToTree = (tree) => {
          return tree.map(item => {
            if (item.id === targetItem.id) {
              const children = [...(item.children || []), draggedItem];
              return {
                ...item,
                children: children.sort((a, b) => {
                  if (a.type !== b.type) return a.type === 'folder' ? -1 : 1;
                  return a.name.localeCompare(b.name);
                })
              };
            }
            if (item.children) {
              return { ...item, children: addToTree(item.children) };
            }
            return item;
          });
        };
        
        const newTree = addToTree(removeFromTree(fileTree));
        setFileTree(newTree);
        setDraggedItem(null);
      };

      // Enhanced AI Chat with better simulation
      const sendChatMessage = async () => {
        if (!chatInput.trim() || aiLoading) return;

        const agentPrefix = agent === 'dashka' ? '[AGENT:DASHKA]' : '[AGENT:CLAUDY]';
        const targetPath = targetFile || activeTab?.name || '';
        const currentCode = monacoRef.current?.getValue() || activeTab?.content || '';

        setChatInput('');
        setAiLoading(true);

        try {
          const response = await simulateAIResponse(agentPrefix, chatInput, currentCode, targetPath);
          
          // Extract proposals from AI response
          if (agent === 'claudy') {
            const newProposals = extractProposalsFromText(response, targetPath);
            setProposals(prev => [...newProposals, ...prev]);
          }

        } catch (error) {
          console.error('AI Chat error:', error);
        } finally {
          setAiLoading(false);
        }
      };

      // Enhanced AI Response Simulation
      const simulateAIResponse = async (agentPrefix, message, code, targetPath) => {
        await new Promise(resolve => setTimeout(resolve, 1500)); // More realistic delay

        if (agentPrefix.includes('DASHKA')) {
          return generateDashkaResponse(message, code);
        } else {
          return generateClaudyResponse(message, targetPath);
        }
      };

      const generateDashkaResponse = (message, code) => {
        const responses = [
          `üèóÔ∏è **Architecture Analysis**

Looking at your request: "${message}"

**Code Structure Assessment:**
- Consider implementing the Single Responsibility Principle
- Your current approach shows good separation of concerns
- Recommend adding error boundaries for better UX
- Consider using custom hooks for state management

**Performance Considerations:**
- Use React.memo for expensive components
- Implement lazy loading for large modules
- Consider code splitting at route level

**Security Best Practices:**
- Sanitize user inputs
- Implement proper authentication
- Use HTTPS for all API calls

Would you like me to elaborate on any of these architectural decisions?`,

          `üèóÔ∏è **Strategic Code Review**

Analyzing: "${message}"

**Current Implementation Strengths:**
‚úÖ Modular component structure
‚úÖ Clear naming conventions  
‚úÖ Proper error handling patterns

**Areas for Improvement:**
üîÑ Consider extracting business logic into custom hooks
üîÑ Implement consistent loading states
üîÑ Add comprehensive unit tests

**Long-term Architectural Recommendations:**
1. Adopt a state management pattern (Context/Redux)
2. Implement proper logging and monitoring
3. Consider micro-frontend architecture for scalability

Let me know if you need specific implementation guidance!`
        ];
        
        return responses[Math.floor(Math.random() * responses.length)];
      };

      const generateClaudyResponse = (message, targetPath) => {
        const lowerMessage = message.toLowerCase();
        
        if (lowerMessage.includes('component')) {
          return `ü§ñ **Component Generation**

Creating a React component for you:

file: ${targetPath || 'components/NewComponent.jsx'}
\`\`\`jsx
import React, { useState, useEffect } from 'react';
import './NewComponent.css';

const NewComponent = ({ 
  title = "Component Title", 
  data = [], 
  onAction = () => {} 
}) => {
  const [isLoading, setIsLoading] = useState(false);
  const [state, setState] = useState({
    count: 0,
    isActive: false
  });

  useEffect(() => {
    // Component initialization
    console.log('Component mounted:', title);
  }, [title]);

  const handleClick = () => {
    setState(prev => ({
      ...prev,
      count: prev.count + 1,
      isActive: !prev.isActive
    }));
    onAction({ type: 'click', count: state.count + 1 });
  };

  const handleReset = () => {
    setState({ count: 0, isActive: false });
    onAction({ type: 'reset' });
  };

  if (isLoading) {
    return <div className="component-loading">Loading...</div>;
  }

  return (
    <div className={\`new-component \${state.isActive ? 'active' : ''}\`}>
      <header className="component-header">
        <h2>{title}</h2>
        <span className="component-badge">Count: {state.count}</span>
      </header>
      
      <main className="component-content">
        {data.length > 0 ? (
          <ul className="component-list">
            {data.map((item, index) => (
              <li key={index} className="component-item">
                {typeof item === 'object' ? item.name || item.title : item}
              </li>
            ))}
          </ul>
        ) : (
          <p className="component-empty">No data available</p>
        )}
      </main>
      
      <footer className="component-actions">
        <button 
          className="btn btn-primary" 
          onClick={handleClick}
        >
          {state.isActive ? 'Deactivate' : 'Activate'}
        </button>
        <button 
          className="btn btn-secondary" 
          onClick={handleReset}
        >
          Reset
        </button>
      </footer>
    </div>
  );
};

export default NewComponent;
\`\`\`

And the accompanying CSS:

file: ${targetPath ? targetPath.replace('.jsx', '.css') : 'components/NewComponent.css'}
\`\`\`css
.new-component {
  border: 1px solid #e1e5e9;
  border-radius: 8px;
  padding: 16px;
  margin: 8px 0;
  transition: all 0.3s ease;
  background: #ffffff;
}

.new-component.active {
  border-color: #1f6feb;
  box-shadow: 0 0 0 3px rgba(31, 111, 235, 0.1);
  background: #f6f8fa;
}

.component-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  padding-bottom: 8px;
  border-bottom: 1px solid #e1e5e9;
}

.component-header h2 {
  margin: 0;
  color: #24292f;
  font-size: 1.25em;
}

.component-badge {
  background: #f6f8fa;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.875em;
  color: #656d76;
}

.component-content {
  margin-bottom: 16px;
}

.component-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.component-item {
  padding: 8px 0;
  border-bottom: 1px solid #f6f8fa;
}

.component-item:last-child {
  border-bottom: none;
}

.component-empty {
  text-align: center;
  color: #656d76;
  font-style: italic;
  padding: 24px;
}

.component-loading {
  text-align: center;
  padding: 24px;
  color: #656d76;
}

.component-actions {
  display: flex;
  gap: 8px;
}

.btn {
  padding: 8px 16px;
  border: 1px solid #d0d7de;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  transition: all 0.2s;
}

.btn-primary {
  background: #1f6feb;
  color: white;
  border-color: #1f6feb;
}

.btn-primary:hover {
  background: #1557d0;
}

.btn-secondary {
  background: #f6f8fa;
  color: #24292f;
}

.btn-secondary:hover {
  background: #e1e5e9;
}
\`\`\``;

        } else if (lowerMessage.includes('function') || lowerMessage.includes('util')) {
          return `ü§ñ **Function Generation**

Creating utility functions:

\`\`\`javascript
// Utility functions collection
export const utils = {
  // Format currency
  formatCurrency: (amount, currency = 'USD', locale = 'en-US') => {
    return new Intl.NumberFormat(locale, {
      style: 'currency',
      currency: currency
    }).format(amount);
  },

  // Debounce function
  debounce: (func, wait, immediate = false) => {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        timeout = null;
        if (!immediate) func(...args);
      };
      const callNow = immediate && !timeout;
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
      if (callNow) func(...args);
    };
  },

  