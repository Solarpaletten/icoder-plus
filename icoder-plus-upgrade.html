<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>iCoder Plus v2.1 - Dual-Agent AI IDE</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/monaco-editor@0.44.0/min/vs/loader.js"></script>
  <script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    :root {
      --bg: #0d1117;
      --surface: #161b22;
      --panel: #21262d;
      --border: #30363d;
      --text: #e6edf3;
      --muted: #7d8590;
      --primary: #238636;
      --accent: #1f6feb;
      --warning: #f85149;
      --success: #28a745;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      overflow: hidden;
    }
    
    .app {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 16px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      min-height: 50px;
    }
    
    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 600;
    }
    
    .badge {
      padding: 4px 8px;
      background: var(--panel);
      border-radius: 6px;
      font-size: 12px;
      color: var(--muted);
    }
    
    .dual-agent-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 8px;
      background: var(--panel);
      border-radius: 6px;
      font-size: 11px;
    }
    
    .agent-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent);
    }
    
    .agent-dot.dashka { background: #ff6b35; }
    .agent-dot.claudy { background: #4ecdc4; }
    
    .main {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    
    /* File Tree Panel */
    .file-tree {
      width: 280px;
      background: var(--surface);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
    }
    
    .tree-header {
      padding: 12px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .tree-controls {
      display: flex;
      gap: 4px;
    }
    
    .tree-btn {
      padding: 4px 8px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      cursor: pointer;
      font-size: 11px;
      transition: all 0.2s;
    }
    
    .tree-btn:hover {
      background: var(--accent);
    }
    
    .search-box {
      padding: 8px 12px;
      border-bottom: 1px solid var(--border);
    }
    
    .search-input {
      width: 100%;
      padding: 6px 8px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      font-size: 12px;
    }
    
    .tree-content {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }
    
    .tree-item {
      display: flex;
      align-items: center;
      padding: 4px 8px;
      margin: 1px 0;
      cursor: pointer;
      border-radius: 4px;
      font-size: 13px;
      user-select: none;
      transition: all 0.15s;
    }
    
    .tree-item:hover {
      background: var(--panel);
    }
    
    .tree-item.selected {
      background: var(--accent);
      color: white;
    }
    
    .tree-item.folder {
      font-weight: 500;
    }
    
    .tree-icon {
      margin-right: 6px;
      font-size: 14px;
    }
    
    .tree-arrow {
      margin-right: 4px;
      font-size: 10px;
      transition: transform 0.2s;
    }
    
    .tree-arrow.expanded {
      transform: rotate(90deg);
    }
    
    .tree-children {
      margin-left: 16px;
    }
    
    /* Context Menu */
    .context-menu {
      position: absolute;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 1000;
      min-width: 160px;
      padding: 4px;
    }
    
    .context-item {
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 4px;
      font-size: 12px;
      transition: background 0.15s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .context-item:hover {
      background: var(--accent);
    }
    
    .context-divider {
      height: 1px;
      background: var(--border);
      margin: 4px 0;
    }
    
    /* Editor Area */
    .editor-area {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    .editor-tabs {
      display: flex;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      overflow-x: auto;
    }
    
    .editor-tab {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      cursor: pointer;
      border-right: 1px solid var(--border);
      font-size: 12px;
      min-width: 120px;
      transition: all 0.2s;
    }
    
    .editor-tab:hover {
      background: var(--panel);
    }
    
    .editor-tab.active {
      background: var(--bg);
      border-bottom: 2px solid var(--accent);
    }
    
    .tab-close {
      padding: 2px;
      border-radius: 2px;
      opacity: 0.6;
      transition: all 0.2s;
      font-size: 10px;
    }
    
    .tab-close:hover {
      opacity: 1;
      background: var(--warning);
      color: white;
    }
    
    .editor-container {
      flex: 1;
      position: relative;
    }
    
    #monaco-editor {
      width: 100%;
      height: 100%;
    }
    
    /* Right Panel - Dual Agent AI */
    .right-panel {
      width: 400px;
      background: var(--surface);
      border-left: 1px solid var(--border);
      display: flex;
      flex-direction: column;
    }
    
    .panel-tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
    }
    
    .panel-tab {
      flex: 1;
      padding: 8px;
      text-align: center;
      cursor: pointer;
      font-size: 11px;
      background: var(--panel);
      border-right: 1px solid var(--border);
      transition: all 0.2s;
      font-weight: 500;
    }
    
    .panel-tab:last-child {
      border-right: none;
    }
    
    .panel-tab.active {
      background: var(--surface);
      border-bottom: 2px solid var(--accent);
    }
    
    .panel-content {
      flex: 1;
      padding: 12px;
      overflow-y: auto;
    }
    
    /* Dual Agent UI */
    .agent-selector {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .agent-option {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      cursor: pointer;
      text-align: center;
      font-size: 11px;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .agent-option.dashka {
      border-color: #ff6b35;
      color: #ff6b35;
    }
    
    .agent-option.claudy {
      border-color: #4ecdc4;
      color: #4ecdc4;
    }
    
    .agent-option.active.dashka {
      background: #ff6b35;
      color: white;
    }
    
    .agent-option.active.claudy {
      background: #4ecdc4;
      color: white;
    }
    
    .target-selector {
      margin-bottom: 12px;
    }
    
    .target-select {
      width: 100%;
      padding: 6px 8px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      font-size: 11px;
    }
    
    .chat-input-area {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .chat-input {
      flex: 1;
      padding: 8px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      font-size: 12px;
      resize: vertical;
      min-height: 60px;
    }
    
    .chat-send {
      padding: 8px 12px;
      background: var(--primary);
      border: none;
      border-radius: 4px;
      color: white;
      cursor: pointer;
      font-size: 12px;
      height: fit-content;
    }
    
    .chat-send:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* Proposals Section */
    .proposals-section {
      border-top: 1px solid var(--border);
      padding-top: 12px;
    }
    
    .proposals-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .proposals-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
    }
    
    .proposals-count {
      font-size: 10px;
      padding: 2px 6px;
      background: var(--accent);
      border-radius: 10px;
      color: white;
    }
    
    .proposal-item {
      padding: 8px;
      margin-bottom: 8px;
      background: var(--panel);
      border-radius: 4px;
      border-left: 3px solid var(--accent);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .proposal-item:hover {
      background: var(--border);
    }
    
    .proposal-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 4px;
    }
    
    .proposal-title {
      font-size: 12px;
      font-weight: 600;
    }
    
    .proposal-meta {
      font-size: 10px;
      color: var(--muted);
    }
    
    .proposal-actions {
      display: flex;
      gap: 4px;
      margin-top: 8px;
    }
    
    .proposal-btn {
      padding: 4px 8px;
      border: 1px solid var(--border);
      border-radius: 3px;
      background: var(--panel);
      color: var(--text);
      cursor: pointer;
      font-size: 10px;
      transition: all 0.2s;
    }
    
    .proposal-btn.apply { border-color: var(--success); color: var(--success); }
    .proposal-btn.insert { border-color: var(--accent); color: var(--accent); }
    .proposal-btn.create { border-color: var(--warning); color: var(--warning); }
    
    .proposal-btn:hover.apply { background: var(--success); color: white; }
    .proposal-btn:hover.insert { background: var(--accent); color: white; }
    .proposal-btn:hover.create { background: var(--warning); color: white; }
    
    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    
    .modal-content {
      width: min(900px, 90vw);
      max-height: 80vh;
      overflow: auto;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .modal-title {
      font-weight: 600;
      font-size: 14px;
    }
    
    .modal-actions {
      display: flex;
      gap: 8px;
    }
    
    .code-preview {
      background: var(--panel);
      border-radius: 4px;
      padding: 12px;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 11px;
      line-height: 1.4;
      overflow-x: auto;
      white-space: pre-wrap;
    }
    
    /* Preview Panel */
    .preview-frame {
      width: 100%;
      height: 300px;
      border: 1px solid var(--border);
      border-radius: 4px;
      background: white;
    }
    
    .console-output {
      margin-top: 12px;
      padding: 8px;
      background: var(--bg);
      border-radius: 4px;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 10px;
      max-height: 150px;
      overflow-y: auto;
    }
    
    .console-log { color: var(--text); }
    .console-error { color: var(--warning); }
    .console-warn { color: #ffa500; }
    
    /* Utility classes */
    .btn {
      padding: 6px 12px;
      border: 1px solid var(--border);
      border-radius: 4px;
      background: var(--panel);
      color: var(--text);
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }
    
    .btn:hover {
      background: var(--accent);
      color: white;
    }
    
    .btn.primary {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    .btn.warning {
      background: var(--warning);
      color: white;
      border-color: var(--warning);
    }
    
    .muted { color: var(--muted); font-size: 11px; }
    .hidden { display: none !important; }
    
    /* Drag and drop styles */
    .drag-over {
      background: rgba(31, 111, 235, 0.1);
      border: 2px dashed var(--accent);
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    // File type icons
    const getFileIcon = (name) => {
      const ext = name.split('.').pop()?.toLowerCase();
      const icons = {
        html: '🟥', htm: '🟥',
        js: '🟦', jsx: '🟦', mjs: '🟦',
        ts: '🟨', tsx: '🟨',
        css: '🟪', scss: '🟪', less: '🟪',
        json: '🟩', jsonc: '🟩',
        md: '📝', txt: '📝',
        png: '🖼️', jpg: '🖼️', gif: '🖼️', svg: '🖼️',
        zip: '📦', rar: '📦',
      };
      return icons[ext] || '📄';
    };

    // Language detection
    const getLanguageFromFilename = (filename) => {
      const ext = filename.split('.').pop()?.toLowerCase();
      const langMap = {
        html: 'html', htm: 'html',
        js: 'javascript', jsx: 'javascript', mjs: 'javascript',
        ts: 'typescript', tsx: 'typescript',
        css: 'css', scss: 'scss', less: 'less',
        json: 'json', jsonc: 'json',
        md: 'markdown', txt: 'plaintext'
      };
      return langMap[ext] || 'plaintext';
    };

    // Initial files structure
    const initialFiles = [
      {
        id: 'root',
        name: 'My Project',
        type: 'folder',
        expanded: true,
        children: [
          {
            id: 'index-html',
            name: 'index.html',
            type: 'file',
            content: `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iCoder Plus Demo</title>
    <link rel="stylesheet" href="styles/main.css">
</head>
<body>
    <div class="container">
        <h1>🚀 Welcome to iCoder Plus v2.1!</h1>
        <p>This is your <strong>Dual-Agent AI IDE</strong>. Try the AI chat with:</p>
        <ul>
            <li><strong>Dashka mode</strong>: Architecture advice and code review</li>
            <li><strong>Claudy mode</strong>: Code generation and automatic insertion</li>
        </ul>
        <button class="btn primary" onclick="showWelcome()">Click Me!</button>
        <div id="output"></div>
    </div>
    <script src="app.js"></script>
</body>
</html>`
          },
          {
            id: 'app-js',
            name: 'app.js',
            type: 'file',
            content: `// iCoder Plus v2.1 - Dual Agent AI IDE
console.log('🚀 App loaded successfully');

function showWelcome() {
    const output = document.getElementById('output');
    output.innerHTML = \`
        <div style="margin-top: 20px; padding: 15px; background: #e8f5e8; border-radius: 8px;">
            <h3>✨ Welcome to the Future of Coding!</h3>
            <p>You're now using a <strong>Dual-Agent AI IDE</strong> where:</p>
            <ul>
                <li><strong>Dashka</strong> helps with architecture and planning</li>
                <li><strong>Claudy</strong> generates and inserts code automatically</li>
            </ul>
            <p>Try asking Claudy: "Create a React component" or "Add a CSS animation"</p>
        </div>
    \`;
    console.log('Welcome message displayed!');
}

// Auto-demo functionality
document.addEventListener('DOMContentLoaded', () => {
    console.log('🎯 Ready for dual-agent AI assistance!');
    
    // Add some interactivity
    const buttons = document.querySelectorAll('button');
    buttons.forEach(btn => {
        btn.addEventListener('mouseenter', () => {
            console.log('Button hover detected');
        });
    });
});`
          },
          {
            id: 'styles-folder',
            name: 'styles',
            type: 'folder',
            expanded: false,
            children: [
              {
                id: 'main-css',
                name: 'main.css',
                type: 'file',
                content: `/* iCoder Plus v2.1 - Main Styles */
:root {
    --primary: #1f6feb;
    --success: #28a745;
    --warning: #ffc107;
    --bg: #f8f9fa;
    --text: #212529;
    --border: #dee2e6;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    line-height: 1.6;
    color: var(--text);
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
}

.container {
    max-width: 800px;
    margin: 0 auto;
    padding: 40px 20px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    margin-top: 40px;
}

h1 {
    color: var(--primary);
    margin-bottom: 20px;
    font-size: 2.5em;
    text-align: center;
}

p, li {
    margin-bottom: 10px;
    font-size: 1.1em;
}

ul {
    margin: 15px 0 15px 20px;
}

.btn {
    display: inline-block;
    padding: 12px 24px;
    font-size: 16px;
    font-weight: 500;
    text-decoration: none;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    margin: 10px 5px;
}

.btn.primary {
    background: var(--primary);
    color: white;
}

.btn.primary:hover {
    background: #1557d0;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(31, 111, 235, 0.3);
}

#output {
    margin-top: 20px;
}`
              }
            ]
          },
          {
            id: 'components-folder',
            name: 'components',
            type: 'folder',
            expanded: false,
            children: []
          }
        ]
      }
    ];

    // Main App Component
    function App() {
      // File tree and editor state
      const [fileTree, setFileTree] = useState(initialFiles);
      const [openTabs, setOpenTabs] = useState([]);
      const [activeTab, setActiveTab] = useState(null);
      const [searchQuery, setSearchQuery] = useState('');
      const [rightPanel, setRightPanel] = useState('ai-chat');
      const [contextMenu, setContextMenu] = useState(null);
      
      // Dual Agent AI state
      const [agent, setAgent] = useState('dashka');
      const [targetFile, setTargetFile] = useState('');
      const [proposals, setProposals] = useState([]);
      const [selectedProposal, setSelectedProposal] = useState(null);
      const [chatInput, setChatInput] = useState('');
      const [aiLoading, setAiLoading] = useState(false);
      
      // Preview state
      const [previewContent, setPreviewContent] = useState('');
      const [consoleOutput, setConsoleOutput] = useState([]);
      
      const editorRef = useRef(null);
      const monacoRef = useRef(null);
      const previewFrameRef = useRef(null);

      // Utility functions
      const generateId = () => Math.random().toString(36).substr(2, 9);

      const findFileById = (tree, id) => {
        for (const item of tree) {
          if (item.id === id) return item;
          if (item.children) {
            const found = findFileById(item.children, id);
            if (found) return found;
          }
        }
        return null;
      };

      const findFileByName = (tree, name) => {
        for (const item of tree) {
          if (item.name === name && item.type === 'file') return item;
          if (item.children) {
            const found = findFileByName(item.children, name);
            if (found) return found;
          }
        }
        return null;
      };

      const getAllFilePaths = (tree, path = '') => {
        let paths = [];
        for (const item of tree) {
          const currentPath = path ? `${path}/${item.name}` : item.name;
          if (item.type === 'file') {
            paths.push(currentPath);
          }
          if (item.children) {
            paths = paths.concat(getAllFilePaths(item.children, currentPath));
          }
        }
        return paths;
      };

      // AI Proposals Parser
      const extractProposalsFromText = (text, targetPath) => {
        const proposals = [];
        
        // Match file-specific blocks: file: path\n```lang\ncode```
        const fileBlockRegex = /file:\s*([^\n]+)\n```(\w+)?\n([\s\S]*?)```/gi;
        let match;
        
        while ((match = fileBlockRegex.exec(text)) !== null) {
          const [, filePath, language, code] = match;
          proposals.push({
            id: generateId(),
            title: `Update ${filePath}`,
            file: filePath.trim(),
            language: language || 'text',
            code: code.trim(),
            type: 'file-specific'
          });
        }

        // Match general code blocks: ```lang\ncode```
        const codeBlockRegex = /```(\w+)?\n([\s\S]*?)```/gi;
        while ((match = codeBlockRegex.exec(text)) !== null) {
          const [, language, code] = match;
          // Skip if already captured as file-specific
          if (!fileBlockRegex.test(match[0])) {
            proposals.push({
              id: generateId(),
              title: `Code snippet (${language || 'text'})`,
              file: targetPath || (activeTab?.name) || '',
              language: language || 'text',
              code: code.trim(),
              type: 'code-block'
            });
          }
        }

        // If no code blocks found, treat entire response as note
        if (proposals.length === 0) {
          proposals.push({
            id: generateId(),
            title: 'AI Response',
            file: targetPath || (activeTab?.name) || '',
            language: 'text',
            code: text,
            type: 'note'
          });
        }

        return proposals;
      };

      // File operations
      const updateFileContent = (fileId, content) => {
        const updateInTree = (tree) => {
          return tree.map(item => {
            if (item.id === fileId) {
              return { ...item, content };
            }
            if (item.children) {
              return { ...item, children: updateInTree(item.children) };
            }
            return item;
          });
        };
        
        setFileTree(updateInTree);
        
        // Update open tabs
        setOpenTabs(tabs => tabs.map(tab => 
          tab.id === fileId ? { ...tab, content } : tab
        ));
        
        if (activeTab?.id === fileId) {
          setActiveTab({ ...activeTab, content });
        }
      };

      const createFile = (parentId, name, content = '') => {
        const newFile = {
          id: generateId(),
          name,
          type: 'file',
          content
        };

        const addToTree = (tree) => {
          return tree.map(item => {
            if (item.id === parentId) {
              return {
                ...item,
                children: [...(item.children || []), newFile].sort((a, b) => {
                  if (a.type !== b.type) return a.type === 'folder' ? -1 : 1;
                  return a.name.localeCompare(b.name);
                })
              };
            }
            if (item.children) {
              return { ...item, children: addToTree(item.children) };
            }
            return item;
          });
        };

        setFileTree(addToTree);
        openFile(newFile);
        return newFile;
      };

      const createFolder = (parentId, name) => {
        const newFolder = {
          id: generateId(),
          name,
          type: 'folder',
          expanded: true,
          children: []
        };

        const addToTree = (tree) => {
          return tree.map(item => {
            if (item.id === parentId) {
              return {
                ...item,
                children: [...(item.children || []), newFolder].sort((a, b) => {
                  if (a.type !== b.type) return a.type === 'folder' ? -1 : 1;
                  return a.name.localeCompare(b.name);
                })
              };
            }
            if (item.children) {
              return { ...item, children: addToTree(item.children) };
            }
            return item;
          });
        };

        setFileTree(addToTree);
      };

      const renameItem = (item, newName) => {
        const updateInTree = (tree) => {
          return tree.map(treeItem => {
            if (treeItem.id === item.id) {
              return { ...treeItem, name: newName };
            }
            if (treeItem.children) {
              return { ...treeItem, children: updateInTree(treeItem.children) };
            }
            return treeItem;
          });
        };
        setFileTree(updateInTree);

        setOpenTabs(tabs => tabs.map(tab => 
          tab.id === item.id ? { ...tab, name: newName } : tab
        ));
        
        if (activeTab?.id === item.id) {
          setActiveTab({ ...activeTab, name: newName });
        }
      };

      const deleteItem = (item) => {
        const removeFromTree = (tree) => {
          return tree.filter(treeItem => {
            if (treeItem.id === item.id) return false;
            if (treeItem.children) {
              treeItem.children = removeFromTree(treeItem.children);
            }
            return true;
          });
        };
        
        setFileTree(removeFromTree);
        setOpenTabs(tabs => tabs.filter(tab => tab.id !== item.id));
        
        if (activeTab?.id === item.id) {
          const remainingTabs = openTabs.filter(tab => tab.id !== item.id);
          setActiveTab(remainingTabs.length > 0 ? remainingTabs[0] : null);
        }
      };

      // Tab management
      const openFile = (file) => {
        if (file.type !== 'file') return;
        
        const existingTab = openTabs.find(tab => tab.id === file.id);
        if (existingTab) {
          setActiveTab(existingTab);
          return;
        }

        const newTab = { ...file };
        setOpenTabs([...openTabs, newTab]);
        setActiveTab(newTab);
      };

      const closeTab = (tab) => {
        const newTabs = openTabs.filter(t => t.id !== tab.id);
        setOpenTabs(newTabs);
        
        if (activeTab?.id === tab.id) {
          setActiveTab(newTabs.length > 0 ? newTabs[newTabs.length - 1] : null);
        }
      };

      const toggleFolder = (folder) => {
        const updateInTree = (tree) => {
          return tree.map(item => {
            if (item.id === folder.id) {
              return { ...item, expanded: !item.expanded };
            }
            if (item.children) {
              return { ...item, children: updateInTree(item.children) };
            }
            return item;
          });
        };
        setFileTree(updateInTree);
      };

      // AI Proposal Actions
      const applyProposal = (proposal, action) => {
        const targetPath = proposal.file || activeTab?.name || '';
        
        if (action === 'apply') {
          // Overwrite entire file
          const file = findFileByName(fileTree, targetPath);
          if (file) {
            updateFileContent(file.id, proposal.code);
          } else {
            // Create new file
            const parentId = fileTree[0]?.id; // Root folder
            createFile(parentId, targetPath, proposal.code);
          }
        } else if (action === 'insert') {
          // Insert at cursor position
          if (monacoRef.current && activeTab) {
            const editor = monacoRef.current;
            const selection = editor.getSelection();
            editor.executeEdits('ai-insert', [{
              range: selection,
              text: proposal.code
            }]);
            updateFileContent(activeTab.id, editor.getValue());
          }
        } else if (action === 'create') {
          // Create new file with custom path
          const customPath = prompt('Enter file path:', proposal.file || 'new-file.txt');
          if (customPath) {
            const parentId = fileTree[0]?.id; // Root folder
            createFile(parentId, customPath, proposal.code);
          }
        }
        
        // Remove proposal after applying
        setProposals(prev => prev.filter(p => p.id !== proposal.id));
        setSelectedProposal(null);
      };

      // AI Chat Handler
      const sendChatMessage = async () => {
        if (!chatInput.trim() || aiLoading) return;

        const agentPrefix = agent === 'dashka' ? '[AGENT:DASHKA]' : '[AGENT:CLAUDY]';
        const targetPath = targetFile || activeTab?.name || '';
        const currentCode = monacoRef.current?.getValue() || activeTab?.content || '';

        const userMessage = {
          role: 'user',
          content: chatInput,
          agent,
          target: targetPath
        };

        setChatInput('');
        setAiLoading(true);

        try {
          // Simulate API call - replace with actual API endpoint
          const response = await simulateAIResponse(agentPrefix, chatInput, currentCode, targetPath);
          
          const aiMessage = {
            role: 'assistant',
            content: response,
            agent
          };

          // Extract proposals from AI response
          if (agent === 'claudy') {
            const newProposals = extractProposalsFromText(response, targetPath);
            setProposals(prev => [...newProposals, ...prev]);
          }

        } catch (error) {
          console.error('AI Chat error:', error);
        } finally {
          setAiLoading(false);
        }
      };

      // Simulate AI Response (replace with real API call)
      const simulateAIResponse = async (agentPrefix, message, code, targetPath) => {
        await new Promise(resolve => setTimeout(resolve, 1000)); // Simulate delay

        if (agentPrefix.includes('DASHKA')) {
          return `🏗️ **Architecture Analysis**

Looking at your request: "${message}"

**Code Structure Recommendations:**
- Consider separating concerns with modular components
- Implement proper error handling
- Follow consistent naming conventions
- Add JSDoc comments for better documentation

**Next Steps:**
1. Plan the component hierarchy
2. Define clear interfaces
3. Implement with proper testing

Would you like me to elaborate on any of these points?`;
        } else {
          // Claudy mode - return code
          if (message.toLowerCase().includes('component')) {
            return `🤖 **Code Generation**

Here's a React component for you:

file: ${targetPath || 'components/NewComponent.jsx'}
\`\`\`jsx
import React, { useState } from 'react';

const NewComponent = ({ title = "Default Title" }) => {
  const [isActive, setIsActive] = useState(false);

  const handleClick = () => {
    setIsActive(!isActive);
    console.log('Component toggled:', !isActive);
  };

  return (
    <div className={\`component \${isActive ? 'active' : ''}\`}>
      <h2>{title}</h2>
      <button onClick={handleClick}>
        {isActive ? 'Deactivate' : 'Activate'}
      </button>
      <p>Status: {isActive ? 'Active' : 'Inactive'}</p>
    </div>
  );
};

export default NewComponent;
\`\`\`

Also adding some CSS:

file: styles/component.css
\`\`\`css
.component {
  padding: 20px;
  border: 2px solid #ddd;
  border-radius: 8px;
  transition: all 0.3s ease;
}

.component.active {
  border-color: #4ecdc4;
  background-color: rgba(78, 205, 196, 0.1);
}

.component h2 {
  margin-bottom: 10px;
  color: #333;
}

.component button {
  padding: 8px 16px;
  border: none;
  border-radius: 4px;
  background: #4ecdc4;
  color: white;
  cursor: pointer;
}

.component button:hover {
  background: #45b7b8;
}
\`\`\``;
          } else if (message.toLowerCase().includes('function')) {
            return `🤖 **Function Generation**

\`\`\`javascript
// Utility function based on your request
function ${message.toLowerCase().includes('async') ? 'async ' : ''}handleUserRequest(data) {
  try {
    // Validate input
    if (!data) {
      throw new Error('Data is required');
    }

    // Process data
    const processed = Array.isArray(data) 
      ? data.map(item => ({ ...item, processed: true }))
      : { ...data, processed: true };

    console.log('Processing completed:', processed);
    return processed;
  } catch (error) {
    console.error('Error processing data:', error);
    throw error;
  }
}

// Usage example
// const result = handleUserRequest({ name: 'John', age: 30 });
\`\`\``;
          } else {
            return `🤖 **Claudy Response**

I can help you generate code! Try asking me to:

- "Create a React component"
- "Write a JavaScript function"  
- "Add CSS styles"
- "Generate HTML markup"
- "Create an API endpoint"

Just specify what you need and I'll provide ready-to-use code blocks that you can apply directly to your files.

What would you like me to build for you?`;
          }
        }
      };

      // Context menu handlers
      const handleRightClick = (e, item) => {
        e.preventDefault();
        setContextMenu({
          x: e.pageX,
          y: e.pageY,
          item
        });
      };

      const handleContextAction = (action, item) => {
        setContextMenu(null);
        
        switch (action) {
          case 'add-file':
            const fileName = prompt('Enter file name:');
            if (fileName) {
              createFile(item.id, fileName);
            }
            break;
            
          case 'add-folder':
            const folderName = prompt('Enter folder name:');
            if (folderName) {
              createFolder(item.id, folderName);
            }
            break;
            
          case 'rename':
            const newName = prompt('Enter new name:', item.name);
            if (newName && newName !== item.name) {
              renameItem(item, newName);
            }
            break;
            
          case 'delete':
            if (confirm(`Delete "${item.name}"?`)) {
              deleteItem(item);
            }
            break;
            
          case 'run-preview':
            if (item.name.endsWith('.html')) {
              updatePreview(item.content || '');
              setRightPanel('preview');
            }
            break;
            
          case 'execute-script':
            if (item.name.endsWith('.js')) {
              executeScript(item.content || '');
              setRightPanel('preview');
            }
            break;
        }
      };

      // Preview functions
      const updatePreview = (htmlContent) => {
        if (previewFrameRef.current) {
          const iframe = previewFrameRef.current;
          const doc = iframe.contentDocument || iframe.contentWindow.document;
          doc.open();
          doc.write(htmlContent);
          doc.close();
        }
      };

      const executeScript = (jsContent) => {
        try {
          setConsoleOutput([]);
          
          // Capture console output
          const originalLog = console.log;
          const originalError = console.error;
          const originalWarn = console.warn;
          
          console.log = (...args) => {
            setConsoleOutput(prev => [...prev, { type: 'log', content: args.join(' ') }]);
            originalLog(...args);
          };
          
          console.error = (...args) => {
            setConsoleOutput(prev => [...prev, { type: 'error', content: args.join(' ') }]);
            originalError(...args);
          };
          
          console.warn = (...args) => {
            setConsoleOutput(prev => [...prev, { type: 'warn', content: args.join(' ') }]);
            originalWarn(...args);
          };

          // Execute script
          eval(jsContent);

          // Restore console
          console.log = originalLog;
          console.error = originalError;
          console.warn = originalWarn;
          
        } catch (error) {
          setConsoleOutput(prev => [...prev, { type: 'error', content: error.message }]);
        }
      };

      // Initialize Monaco Editor
      useEffect(() => {
        const initMonaco = () => {
          if (editorRef.current && !monacoRef.current) {
            monacoRef.current = monaco.editor.create(editorRef.current, {
              value: '',
              language: 'javascript',
              theme: 'vs-dark',
              automaticLayout: true,
              fontSize: 13,
              lineNumbers: 'on',
              minimap: { enabled: false },
              padding: { top: 16 }
            });

            // Auto-save on change
            monacoRef.current.onDidChangeModelContent(() => {
              if (activeTab) {
                const content = monacoRef.current.getValue();
                updateFileContent(activeTab.id, content);
                
                // Auto-preview HTML files
                if (activeTab.name.endsWith('.html')) {
                  updatePreview(content);
                }
              }
            });
          }
        };

        if (window.monaco) {
          initMonaco();
        } else {
          require(['vs/editor/editor.main'], initMonaco);
        }

        // Auto-open index.html
        const indexFile = findFileByName(fileTree, 'index.html');
        if (indexFile && openTabs.length === 0) {
          openFile(indexFile);
        }
      }, []);

      // Update editor when active tab changes
      useEffect(() => {
        if (monacoRef.current && activeTab) {
          const language = getLanguageFromFilename(activeTab.name);
          const model = monaco.editor.createModel(activeTab.content || '', language);
          monacoRef.current.setModel(model);
          
          if (activeTab.name.endsWith('.html')) {
            updatePreview(activeTab.content || '');
          }
        }
      }, [activeTab]);

      // Hide context menu on click
      useEffect(() => {
        const handleClick = () => setContextMenu(null);
        document.addEventListener('click', handleClick);
        return () => document.removeEventListener('click', handleClick);
      }, []);

      // Auto-save to localStorage
      useEffect(() => {
        localStorage.setItem('icoder-project-v2', JSON.stringify(fileTree));
      }, [fileTree]);

      // Load from localStorage
      useEffect(() => {
        const saved = localStorage.getItem('icoder-project-v2');
        if (saved) {
          try {
            const project = JSON.parse(saved);
            setFileTree(project);
          } catch (e) {
            console.warn('Failed to load project:', e);
          }
        }
      }, []);

      // Render tree recursively
      const renderTreeItem = (item, level = 0) => {
        const isSelected = activeTab?.id === item.id;
        const allPaths = getAllFilePaths(fileTree);

        return (
          <div key={item.id} style={{ marginLeft: level * 12 }}>
            <div
              className={`tree-item ${item.type} ${isSelected ? 'selected' : ''}`}
              onClick={() => {
                if (item.type === 'folder') {
                  toggleFolder(item);
                } else {
                  openFile(item);
                }
              }}
              onContextMenu={(e) => handleRightClick(e, item)}
            >
              {item.type === 'folder' && (
                <span className={`tree-arrow ${item.expanded ? 'expanded' : ''}`}>
                  ►
                </span>
              )}
              <span className="tree-icon">
                {item.type === 'folder' ? '📂' : getFileIcon(item.name)}
              </span>
              <span>{item.name}</span>
            </div>
            
            {item.type === 'folder' && item.expanded && item.children && (
              <div className="tree-children">
                {item.children.map(child => renderTreeItem(child, level + 1))}
              </div>
            )}
          </div>
        );
      };

      return (
        <div className="app">
          {/* Top Bar */}
          <div className="topbar">
            <div className="brand">
              <span style={{ fontSize: 22 }}>⚡ iCoder Plus v2.1</span>
              <span className="badge">Dual-Agent AI IDE</span>
            </div>
            
            <div className="dual-agent-indicator">
              <div className={`agent-dot ${agent}`}></div>
              <span>Active: {agent === 'dashka' ? 'Dashka (Architect)' : 'Claudy (Code Gen)'}</span>
            </div>
          </div>

          <div className="main">
            {/* File Tree */}
            <div className="file-tree">
              <div className="tree-header">
                <span style={{ fontWeight: 600, fontSize: 13 }}>📁 Project Files</span>
                <div className="tree-controls">
                  <button 
                    className="tree-btn" 
                    onClick={() => {
                      const name = prompt('New project name:');
                      if (name) {
                        setFileTree([{
                          id: generateId(),
                          name,
                          type: 'folder',
                          expanded: true,
                          children: []
                        }]);
                        setOpenTabs([]);
                        setActiveTab(null);
                      }
                    }}
                    title="New Project"
                  >
                    🆕
                  </button>
                  <button 
                    className="tree-btn"
                    onClick={() => {
                      const zip = new JSZip();
                      // Add export logic here
                      alert('Export feature coming soon!');
                    }}
                    title="Export ZIP"
                  >
                    📤
                  </button>
                </div>
                
                <div className="code-preview">
                  {selectedProposal.code}
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // Render the app
    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
              </div>

              <div className="search-box">
                <input
                  type="text"
                  className="search-input"
                  placeholder="🔍 Search files..."
                  value={searchQuery}
                  onChange={(e) => setSearchQuery(e.target.value)}
                />
              </div>

              <div className="tree-content">
                {fileTree.map(item => renderTreeItem(item))}
              </div>
            </div>

            {/* Editor Area */}
            <div className="editor-area">
              {/* Editor Tabs */}
              <div className="editor-tabs">
                {openTabs.map(tab => (
                  <div
                    key={tab.id}
                    className={`editor-tab ${activeTab?.id === tab.id ? 'active' : ''}`}
                    onClick={() => setActiveTab(tab)}
                  >
                    <span className="tree-icon">{getFileIcon(tab.name)}</span>
                    <span>{tab.name}</span>
                    <span 
                      className="tab-close"
                      onClick={(e) => {
                        e.stopPropagation();
                        closeTab(tab);
                      }}
                    >
                      ×
                    </span>
                  </div>
                ))}
              </div>

              {/* Monaco Editor */}
              <div className="editor-container">
                <div ref={editorRef} id="monaco-editor"></div>
              </div>
            </div>

            {/* Right Panel - Dual Agent AI */}
            <div className="right-panel">
              <div className="panel-tabs">
                <div 
                  className={`panel-tab ${rightPanel === 'ai-chat' ? 'active' : ''}`}
                  onClick={() => setRightPanel('ai-chat')}
                >
                  🤖 Dual AI
                </div>
                <div 
                  className={`panel-tab ${rightPanel === 'preview' ? 'active' : ''}`}
                  onClick={() => setRightPanel('preview')}
                >
                  ▶ Preview
                </div>
              </div>

              <div className="panel-content">
                {rightPanel === 'ai-chat' && (
                  <div className="ai-chat-panel">
                    {/* Agent Selector */}
                    <div className="agent-selector">
                      <div
                        className={`agent-option dashka ${agent === 'dashka' ? 'active' : ''}`}
                        onClick={() => setAgent('dashka')}
                      >
                        🏗️ Dashka<br/>
                        <small>Architecture & Review</small>
                      </div>
                      <div
                        className={`agent-option claudy ${agent === 'claudy' ? 'active' : ''}`}
                        onClick={() => setAgent('claudy')}
                      >
                        🤖 Claudy<br/>
                        <small>Code Generation</small>
                      </div>
                    </div>

                    {/* Target File Selector */}
                    <div className="target-selector">
                      <label className="muted">Target File:</label>
                      <select 
                        className="target-select"
                        value={targetFile}
                        onChange={(e) => setTargetFile(e.target.value)}
                      >
                        <option value="">(current: {activeTab?.name || 'none'})</option>
                        {getAllFilePaths(fileTree).map(path => (
                          <option key={path} value={path}>{path}</option>
                        ))}
                      </select>
                    </div>

                    {/* Chat Input */}
                    <div className="chat-input-area">
                      <textarea
                        className="chat-input"
                        placeholder={agent === 'dashka' 
                          ? "Ask Dashka for architecture advice, code review, or planning..." 
                          : "Ask Claudy to generate components, functions, or code snippets..."
                        }
                        value={chatInput}
                        onChange={(e) => setChatInput(e.target.value)}
                        onKeyDown={(e) => {
                          if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                            sendChatMessage();
                          }
                        }}
                      />
                      <button 
                        className="chat-send"
                        onClick={sendChatMessage}
                        disabled={aiLoading || !chatInput.trim()}
                      >
                        {aiLoading ? '⏳' : '🚀'}
                      </button>
                    </div>

                    {/* Proposals Section */}
                    <div className="proposals-section">
                      <div className="proposals-header">
                        <span className="proposals-title">Code Proposals</span>
                        {proposals.length > 0 && (
                          <span className="proposals-count">{proposals.length}</span>
                        )}
                      </div>

                      {proposals.length === 0 ? (
                        <div className="muted" style={{ textAlign: 'center', padding: 20 }}>
                          {agent === 'dashka' 
                            ? "💡 Dashka provides architecture guidance"
                            : "🤖 Claudy will generate code proposals here"
                          }
                        </div>
                      ) : (
                        proposals.map(proposal => (
                          <div 
                            key={proposal.id}
                            className="proposal-item"
                            onClick={() => setSelectedProposal(proposal)}
                          >
                            <div className="proposal-header">
                              <div>
                                <div className="proposal-title">{proposal.title}</div>
                                <div className="proposal-meta">
                                  📁 {proposal.file || 'current'} • {proposal.language}
                                </div>
                              </div>
                            </div>
                            
                            <div className="proposal-actions">
                              <button 
                                className="proposal-btn apply"
                                onClick={(e) => {
                                  e.stopPropagation();
                                  applyProposal(proposal, 'apply');
                                }}
                                title="Replace entire file content"
                              >
                                Apply
                              </button>
                              <button 
                                className="proposal-btn insert"
                                onClick={(e) => {
                                  e.stopPropagation();
                                  applyProposal(proposal, 'insert');
                                }}
                                title="Insert at cursor position"
                              >
                                Insert
                              </button>
                              <button 
                                className="proposal-btn create"
                                onClick={(e) => {
                                  e.stopPropagation();
                                  applyProposal(proposal, 'create');
                                }}
                                title="Create new file"
                              >
                                Create
                              </button>
                            </div>
                          </div>
                        ))
                      )}
                    </div>
                  </div>
                )}

                {rightPanel === 'preview' && (
                  <div className="preview-panel">
                    <h3 style={{ marginBottom: 12, fontSize: 14 }}>⚡ Live Preview</h3>
                    
                    <iframe 
                      ref={previewFrameRef}
                      className="preview-frame"
                      title="Preview"
                    />

                    {consoleOutput.length > 0 && (
                      <div className="console-output">
                        <h4 style={{ marginBottom: 8, fontSize: 12 }}>📟 Console Output:</h4>
                        {consoleOutput.map((log, i) => (
                          <div key={i} className={`console-${log.type}`}>
                            {log.content}
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                )}
              </div>
            </div>
          </div>

          {/* Context Menu */}
          {contextMenu && (
            <div 
              className="context-menu"
              style={{ 
                left: contextMenu.x, 
                top: contextMenu.y 
              }}
            >
              {contextMenu.item.type === 'folder' && (
                <>
                  <div 
                    className="context-item"
                    onClick={() => handleContextAction('add-file', contextMenu.item)}
                  >
                    📄 New File
                  </div>
                  <div 
                    className="context-item"
                    onClick={() => handleContextAction('add-folder', contextMenu.item)}
                  >
                    📁 New Folder
                  </div>
                  <div className="context-divider"></div>
                </>
              )}
              
              {contextMenu.item.type === 'file' && contextMenu.item.name.endsWith('.html') && (
                <div 
                  className="context-item"
                  onClick={() => handleContextAction('run-preview', contextMenu.item)}
                >
                  ▶ Run in Preview
                </div>
              )}
              
              {contextMenu.item.type === 'file' && contextMenu.item.name.endsWith('.js') && (
                <div 
                  className="context-item"
                  onClick={() => handleContextAction('execute-script', contextMenu.item)}
                >
                  ⚡ Execute Script
                </div>
              )}
              
              <div 
                className="context-item"
                onClick={() => handleContextAction('rename', contextMenu.item)}
              >
                ✏️ Rename
              </div>
              <div 
                className="context-item"
                onClick={() => handleContextAction('delete', contextMenu.item)}
              >
                🗑️ Delete
              </div>
            </div>
          )}

          {/* Proposal Preview Modal */}
          {selectedProposal && (
            <div className="modal-overlay" onClick={() => setSelectedProposal(null)}>
              <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                <div className="modal-header">
                  <div className="modal-title">
                    {selectedProposal.title}
                    <div className="muted">→ {selectedProposal.file || 'current'}</div>
                  </div>
                  <div className="modal-actions">
                    <button 
                      className="btn primary"
                      onClick={() => applyProposal(selectedProposal, 'apply')}
                    >
                      Apply
                    </button>
                    <button 
                      className="btn"
                      onClick={() => applyProposal(selectedProposal, 'insert')}
                    >
                      Insert
                    </button>
                    <button 
                      className="btn"
                      onClick={() => applyProposal(selectedProposal, 'create')}
                    >
                      Create
                    </button>
                    <button 
                      className="btn"
                      onClick={() => setSelectedProposal(null)}
                    >
                      Close
                    </button>
                  </div>
                </div>
                